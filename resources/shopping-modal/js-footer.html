<script type="text/javascript">
  var cookieBasketInfo = "shopping_basket";

  function readBasketInfo()
  {
    var basketInfo = JSON.parse(localStorage.getItem(cookieBasketInfo) || "{}");
    if(!basketInfo.games)
      basketInfo.games = [];

    return basketInfo;
  }

  function saveBasketInfo(basketInfo)
  {
    localStorage.setItem(cookieBasketInfo, JSON.stringify(basketInfo), 30);
  }

  function putGameInBasket(id_idcgame){
    if(!gamedata || !gamedata[id_idcgame]){
      consonle.log(`Error: adding invalid game ${id_idcgame}`)
      return;
    }

    var basketInfo = readBasketInfo();

    if(!basketInfo.games.includes(id_idcgame))
      basketInfo.games.push(id_idcgame);

    saveBasketInfo(basketInfo);
    refreshCartCount(basketInfo.games.length);
    
    $(`.cart-btn[id_idcgame=${id_idcgame}]`).closest(".card").find(".inCart").addClass("d-block");
    $(`.cart-btn[id_idcgame=${id_idcgame}]`).closest(".game-card-rectangular").find(".inCart").addClass("d-block");
  }
  
  function removeGameFromBasket(id_idcgame){
    var basketInfo = readBasketInfo();
    
    const index = basketInfo.games.indexOf(id_idcgame);
    if (index > -1) {
      basketInfo.games.splice(index, 1);
    }
    
    saveBasketInfo(basketInfo);
    refreshCartCount(basketInfo.games.length);
    
    $(`.cart-btn[id_idcgame=${id_idcgame}]`).closest(".card").find(".inCart").removeClass("d-block");
    $(`.cart-btn[id_idcgame=${id_idcgame}]`).closest(".game-card-rectangular").find(".inCart").removeClass("d-block");

    // speical for checkout orders
    $(`.btn-remove-cart-item[id_idcgame=${id_idcgame}]`).closest(".game-block.order").remove();
  }

  function refreshCartCount(count = null){
    if(!count){
      var basketInfo = readBasketInfo();
      count = basketInfo.games.length;
    }

    var type = "rubberBand";
    var counter = count;
    $(".shopping-cart").find("i").addClass(type);
    $(".shopping-cart").find("span").text(counter);
    $(".shopping-cart").find("span").addClass("bg-gray-900");
    setTimeout(function() {
          $(".shopping-cart").find("i").removeClass(type);
          $(".shopping-cart").find("span").removeClass("bg-gray-900");
      },1000);
  }

  function calcCartPrice()
  {
    var result = { 
      count: 0, 
      original_price: 0, 
      price: 0, 
      discount: 0, 
      currency: user_currency || "EUR", 
      simbol: user_currency_symbol || "â‚¬",
      games: [] 
    };

    var basketInfo = readBasketInfo();

    for(var i = 0; i < basketInfo.games.length; i ++ ){
      var gData = gamedata && gamedata[basketInfo.games[i]];
      if(!gData) continue;

      var gPrice = (gData && gData.common_params && gData.common_params && gData.common_params.game_price && gData.common_params.game_price[result.currency]) || 0;
      if(gPrice <= 0) continue;

      var discount_percent = gData.common_params.game_offer_discount_percent || 0, discount_price = (gPrice * discount_percent / 100).toFixed(2);
      gPrice = (gPrice - discount_price).toFixed(2);

      result.count = result.count + 1;
      result.original_price = (result.original_price - (0-gPrice)).toFixed(2);
      result.price = (result.price - (0 - (gPrice - discount_price).toFixed(2))).toFixed(2);
      result.discount = (result.discount -(0 - discount_price)).toFixed(2);
      result.games.push({ 
        gameID: basketInfo.games[i],
        currency: result.currency, 
        original_price: gPrice, 
        discount: discount_price,
        discount_percent: discount_percent,
        price: (gPrice - discount_price).toFixed(2), 
        data: gData 
      });
    }

    return result;
  }
  
</script>